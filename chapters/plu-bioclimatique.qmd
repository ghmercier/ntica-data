---
title: "TD PLU Bioclimatique"
format: html
execute:
    eval: false
---

Dans ce TD, nous allons mettre en pratique quelques compétences acquises
dans les séances précédentes et en acquérir de nouvelles sur un cas
d'étude : le PLU Bioclimatique parisien.

Pour mémoire, la Ville de Paris a adopté en novembre 2024 son nouveau plan
local d'urbanisme. La mise en révision avait été engagée en décembre 2020.
Après une phase de concertation, le Conseil de Paris avait arrêté en juin
2023 un projet de PLU, qui a fait l'objet d'une enquête publique au tout
début de 2024.

À cette époque, le dossier d'enquête publique consistait en une multitude
de gros fichiers PDF : pas de géoportail, pas de couches SIG… Si l'on
voulait exploiter les données, il fallait **se débrouiller**.

Nous allons voir comment !


## Les planches graphiques au 1/2000^e^

Dans le PLU, l'une des pièces-clés est l'atlas des planches au 1/2000^e^.
Ces cartes regroupent les règles d'urbanisme applicables sur le
territoire parisien. Elles représentent une traduction graphique du
règlement écrit.

L'atlas est aujourd'hui accessible en ligne sur le site des
[Règles d'urbanisme de Paris](https://regles-urbanisme.paris.fr/).


### Une planche

Notre objectif va être d'afficher une des planches dans QGIS. On pourra
ainsi superposer d'autres couches pour nos analyses. Pour cela, on va 
**télécharger** l'image de la carte, la **traiter** et la 
**géoréférencer**.


#### Téléchargement

J'ai choisi la planche D-05, qui représente une partie du 8^e^
arrondissement.

- Sur le site des Règles d'urbanisme de Paris, dans l'onglet 
  [Documentations](https://regles-urbanisme.paris.fr/plu-bioclimatique/jsp/site/Portal.jsp?document_id=198&portlet_id=45),
  trouver le plan de repérage de l'atlas.
- Cliquer sur le rectangle D-05.
- Dans la pop-up qui surgit, cliquer sur **Vue** pour télécharger la planche
  au format PDF.

[![](/resources/plu-bio/atlas_planches.jpeg)](https://regles-urbanisme.paris.fr/plu-bioclimatique/jsp/site/Portal.jsp?document_id=198&portlet_id=45#consultation_html)


#### Traitement

Nous avons un fichier PDF. Il nous faut le convertir au format image, 
puis éliminer le cartouche afin de ne conserver que la carte. 
On peut par exemple utiliser GIMP, ou Photoshop.

Pour aller plus vite, l'image déjà traitée est téléchargeable 
[ici](https://www.normalesup.org/~gmercier/D_05.jpg).

![](/resources/plu-bio/gimp_rognage.jpeg)


#### Géoréférencement

Géoréférencer une image, c'est associer à chacun des pixels qui la composent
une coordonnée géographique. Pour cela, il suffit de donner à QGIS les
coordonnées de quelques **points de contrôle** (aussi appelés points
d'appuis). Il se charge d'interpoler tous les autres.


##### Couche de référence

La qualité du géoréférencement dépend donc en grande partie du choix des
points de contrôle. Pour être le plus précis possible, on va charger dans
QGIS l'une des couches utilisée par l'Atelier parisien d'urbanisme (APUR)
pour établir les cartes du PLU : la couche de 
l'[emprise bâtie de Paris](https://opendata.apur.org/datasets/Apur::emprise-batie-paris/about).

Ce sera l'occasion d'apprendre comment utiliser des géoservices,
c'est-à-dire des flux de données sans téléchargement préalable, puisque
l'APUR utilise ArcGIS Server.

- Créer un projet vide dans QGIS
- Sélectionner le SCR 2154 (RGF93v1 / Lambert-93)
- **Couche > Ajouter une couche de serveur ArcGIS REST**
- URL du serveur : [https://carto2.apur.org/apur/rest/services/OPENDATA/](https://carto2.apur.org/apur/rest/services/OPENDATA/)

![](/resources/plu-bio/arcgis_rest.jpeg)


Dans la liste des couches qui s'affiche, trouver **EMPRISE_BATIE_PARIS**
et ajouter le 2^e^ **Période de construction**. C'est un flux image et non
un flux vectoriel, cela se chargera plus rapidement.

![](/resources/plu-bio/arcgis_emprises.jpeg)


##### Géocodage

Ouvrir l'outil de géoréférencement : 

- **Couche > Géoréférencer**

Puis, dans la nouvelle fenêtre qui s'ouvre :

- **Fichier > Ouvrir un raster**
- Choisir le fichier `D_05.jpg`

On définit ensuite les paramètres de la transformation.

On conservera les paramètres proposés par défaut :

- Type de transformation : **Linéaire**
- Mode de ré-échantillonnage : **Plus proche voisin**

Mais on cochera la case **Créer seulement un fichier World**.

Traduction : le fichier que l'on a est très propre, l'image n'a pas été
déformée, la projection source est très certainement la même que la
projection cible = on a seulement besoin de réduire/agrandir, tourner,
translater l'image et non de la tordre pour l'ajuster.

![](/resources/plu-bio/parametres_transformation.jpeg)

Puis, avec l'outil prévu à cet effet, sélectionner des points de contrôle,
en cliquant successivement sur un point de l'image puis le même point sur la
carte. On peut ici se contenter de **trois points** non alignés et distants
les uns des autres. À partir de 3 points, QGIS calcule les erreurs de
géoréférencement : en règle générale, il est bon d'avoir des écarts
inférieurs à 10 pixels.

![](/resources/plu-bio/points-de-controles.jpeg)

Les points de contrôles utilisés dans l'image ci-dessous sont téléchargeables
[ici](/resources/plu-bio/D_05.jpg.points). On peut les charger si on le 
souhaite.


Appliquer ensuite la transformation. La carte s'affiche à son emplacement dans
Paris, on peut vérifier la qualité du géoréférencement en affichant notre
couche de référence et en appliquant une légère transparence à l'image
recalée.

![](/resources/plu-bio/carte_georeferencee.jpeg)


##### Fichier World

Par curiosité, et parce que cela nous sera utile plus tard, allons voir dans
le dossier contenant l'image `D_05.jpg`. On remarque qu'un nouveau fichier a
été créé : `D_05.wld`. C'est en lisant ce fichier que QGIS est capable de
transformer la coordonnée d'un pixel de l'image (ex : 234, 545) en une
coordonnée géographique (ex: 647&nbsp;770, 6&nbsp;864&nbsp;143).

On peut ouvrir ce fichier avec un éditeur de texte. 

![](/resources/plu-bio/fichier_world.jpeg)

On retiendra :

- que les valeurs A et D sont des facteurs **d'échelle**, c'est-à-dire 
  qu'ils donnent la taille d'un pixel dans les unités du SCR utilisé. Dans
  notre cas, 1 pixel sur l'image = 0,169 m dans la réalité.
- que les valeurs B et C sont des termes de **rotation**. Dans notre cas, 
  l'image n'a pas besoin d'être pivotée, elle est bien au nord, les termes
  sont donc nuls.
- que les valeurs E et F sont des termes de **translation**, c'est-à-dire
  qu'ils donnent la coordonnée géographique du point supérieur gauche de la
  carte. On peut le vérifier sur l'image ci-dessous.

Pour les *gory details*, se référer à 
[cette page](https://pro.arcgis.com/en/pro-app/latest/help/data/imagery/world-files-for-raster-datasets.htm).

![](/resources/plu-bio/point_reference.jpeg)


### Plein de planches

Nous avons traité une seule planche. Comment pourrait-on procéder si l'on 
voulait géoréférencer **toutes** les planches du PLU ? Il y a heureusement
des solutions pour automatiser ce qu'on vient de faire manuellement,
on va les esquisser ci-dessous.


#### Téléchargement

On voit sur le site du PLU qu'un fichier avec la
[liste des planches](https://regles-urbanisme.paris.fr/plu-bioclimatique/servlet/plugins/document/resource?id=751&id_attribute=93&working_content=true) 
est disponible. 

C'est un fichier PDF qui contient les liens vers chacune des 134 planches.
Problème : ils ne sont pas apparents… On doit donc les extraire.

- Solution sans code : extraction avec un utilitaire en ligne comme 
  [Supertool](https://supertool.org/fr/extract-urls-and-links-from-pdfs/).
- Solution avec code : extraction avec un mini script qui utilise la 
  libraire [`PyMuPDF`](https://github.com/pymupdf/pymupdf).

```{python}
import pymupdf

doc = pymupdf.open('Consultation_des_planches_au_1_sur_2000.pdf')

for page in doc:
   for link in page.get_links():
       url = link['uri']
       # Do something with url

```

Voici un 
[fichier texte](/resources/plu-bio/liste_urls.txt)
avec la liste des liens extraits. Mais on voit qu'ils sont cassés : le 
prestataire IT de la Ville de Paris (dont le nom figure dans les 
métadonnées du PDF) a oublié de substituer au nom du serveur de test 
celui utilisé en production !

On peut s'en charger grâce à la commande Find/Replace d'un éditeur de texte,
ou à un coup de ligne de commande.

```{sh}
cat liste_urls.txt | sed -e 's/k04-siteplubioclimatique.form.apps.paris.md/regles-urbanisme.paris.fr/'

```

![](/resources/plu-bio/liste_urls_replace_all.jpeg)

Ceci fait, il est possible de télécharger tous les fichiers avec une boucle
en ligne de commande.

```{sh}
while read url; do wget --content-disposition $url; done < liste_urls.txt

```


#### Traitement

Toutes les planches PDF sont bâties sur le même modèle, il est donc aisé
d'automatiser la conversion en JPG et le rognage du cartouche. 

Photoshop sait très bien le faire, GIMP également, mais avec un plugin. Le
plus rapide serait d'utiliser 
[ImageMagick](https://imagemagick.org/)
en ligne de commande.

```{sh}
# Pour les curieux, la commande pour convertir et recadrer
# le fichier PDF qu'on a utilisé plus haut
convert -density 300 D_05.pdf D_05.jpg
convert D_05.jpg -crop 6492x4720+232+136 +repage crop/D_05.jpg

```


#### Géoréférencement

Pour géoréférencer les images obtenues, il faudrait simplement créer les
fichiers World correspondant à chaque planche. 

Pour cela, on remarque que les planches sont espacées très régulièrement :
en fait, chaque planche est décalée de 750m en latitude et de 1000m en
longitude. Pour générer les fichiers World, on pourrait donc partir des 
coordonnées de D_05 et recalculer les termes de translation (paramètres E 
et F) des autres planches, en laissant le facteur d'échelle et 
les termes de rotation inchangés.

![](/resources/plu-bio/batch_fichier_world.jpeg)

Faisons le test sur un exemple : 

- Télécharger le fichier [`E_05.jpg`](https://www.normalesup.org/~gmercier/E_05.jpg).
- Copier le fichier `D_05.wld` en un fichier `E_05.wld`
- Ouvrir le fichier `E_05.wld` et ajouter 1000 au nombre de la 5e ligne
- Ajouter la couche `E_05.jpg` dans QGIS : **Couches > Ajouter une couche 
  Raster **

Miracle : la couche est parfaitement ajustée !

![](/resources/plu-bio/ajustement_parfait.jpeg)



## Les emplacements réservés

Le règlement du PLU liste dans son annexe V "*les emplacements réservés en vue
de la réalisation de certains types de logements*" : logements locatifs
sociaux et logements en BRS.

Cette liste est donnée sous la forme d'un tableau avec des adresses qui
s'étend sur 33 pages d'un fichier PDF. Notre objectif va être de construire
le semis de points des emplacements réservés à charger sous QGIS. Pour cela,
il faut **extraire** les pages intéressantes, **récupérer** les données
textuelles, **nettoyer** le fichier, **géocoder** les adresses, **charger** la
couche et **vérifier** que tout va bien.


### Une page

Comme dans la partie précédente, on va se faire la main sur une seule page
d'adresses, avant de voir comment généraliser. On restera
dans le 8^e^ arrondissement.

#### Extraction

- Sur le site Règles d'urbanisme de Paris, dans l'onglet 
  [Documentations](https://regles-urbanisme.paris.fr/plu-bioclimatique/jsp/site/Portal.jsp?document_id=198&portlet_id=45),
  télécharger le volume 1 du Tome 2 du règlement.
- Extraire la page 51 du PDF.

Pour extraire la page, on peut utiliser par exemple Adobe Pro, 
[PDF Sam Basic](https://pdfsam.org/fr/pdfsam-basic/), 
ou bien [QPDF](https://qpdf.sourceforge.io/) si on préfère la ligne de
commande.

```{sh}
qpdf --empty --pages REG2A1.pdf 51 -- p51.pdf

```

La page extraite est téléchargeable [ici](/resources/plu-bio/p51.pdf) si
besoin.

#### Conversion

En examinant la page, on s'aperçoit que le texte a été transformé en image
lors de la création du PDF : on ne peut directement copier/coller, il faut
au préalable une étape de reconnaissance optique de caractères (OCR en
anglais) pour récupérer le texte.

![](/resources/plu-bio/pdf_mode_image.jpeg){width=20%}

Plusieurs options s'offrent à nous : 

- Si on dispose d'**Acrobat Pro** (version payante du célèbre lecteur de PDF),
  on peut utiliser la fonction Scan et OCR.
- Si on aime les GAFAM, on peut recourir à **un LLM généraliste** comme
  ChatGPT, Gemini, DeepSeek ou Le Chat.

![](/resources/plu-bio/ocr_gemini.jpeg)

- On peut aussi faire appel à des **services plus spécialisés**, peu chers
  et remarquablement efficaces, comme
  [ExtractTable.com](https://extracttable.com/), 
  créé par une jeune entreprise indienne. C'est celle que nous allons
  retenir. Pour les besoins du cours vous pouvez utiliser la clé API ci-dessous.

```{sh}
API_KEY = H1qZ3YHuNPJR6ueRTpcYEyphdrTilu8wZR3bxPAK
```

![](/resources/plu-bio/extracttable.jpeg)

Le fichier Excel qui en résulte est téléchargeable
[ici](/resources/plu-bio/p51.pdf.xlsx) si besoin.


#### Nettoyage

Avant le géocodage, un prétraitement des données est nécessaire. 

- Il faut ajouter une colonne `CP` et une colonne `VILLE`. 
- La colonne `Adresse` contient parfois deux adresses, on va les séparer à
  la main, en dupliquant la ligne concernée et ne conservant qu'une adresse
  dans chacune des deux lignes obtenues.

![](/resources/plu-bio/excel_doublons.jpeg)

Le fichier nettoyé est téléchargeable
[ici](/resources/plu-bio/p51.pdf-clean.xlsx) en Excel et
[là](/resources/plu-bio/p51.pdf-clean.csv) en CSV si besoin.


#### Géocodage

Pour géocoder le fichier, rendez-vous sur le 
[Géocodeur](https://adresse.data.gouv.fr/outils/csv)
de la Base Nationale Adresse.

![](/resources/plu-bio/geocodage_ban.jpeg)

Le fichier géocodé est téléchargeable
[ici](/resources/plu-bio/p51.pdf-clean.geocoded.csv) en CSV 
si besoin.


#### Chargement

Le fichier CSV géocodé s'ouvre directement avec QGIS.

- **Couche > Ajouter une couche de texte délimité**

![](/resources/plu-bio/semis_de_points_ok.jpeg)


#### Vérifications


Il est bon de vérifier les imprécisions éventuelles dans le géocodage.
Ainsi, le géocodeur a traduit l'adresse `1-3 rue de Cerisoles` par le `3 rue de
Cerisoles`. En conséquence, le point n'est pas correctement placé. Fort
heureusement, le géocodeur fournit des indications sur le degré de confiance
à accorder aux résultats via le champ `result_score`. On peut filtrer les
enregistrements avec les scores les plus bas.

![](/resources/plu-bio/imprecisions.jpeg)



### Pleins de pages

Et si l'on devait traiter les 33 pages pour reconstituer l'ensemble du semis
de points ? Quelques indications seulement sur ce que l'on pourrait faire : 

- Utiliser l'API d'ExtractTable plutôt que l'interface graphique pour
  extraire en lot les données.
- Fusionner les fichiers CSV obtenus.
- Dédupliquer les lignes en détectant les doubles adresses avec une
  expression régulière. 

Voici la [carte](https://umap.openstreetmap.fr/fr/map/plub-carte-des-emplacements-reserves-logements_940982) 
des emplacements réservés tels qu'ils étaient avant l'enquête publique,
que j'avais constituée en 2023. Voici également la
[couche](plub_carte_des_emplacements_reserves_logements_2023.geojson)
(au format GeoJSON) des données qu'elle représente.

Chargez cette couche dans QGIS. Identifiez-vous sur la feuille D5 des
emplacements réservés qui ont disparu après l'enquête publique ?…

<details>

<summary>Solution</summary>

Par exemple le 30 bis rue Copernic, à l'ouest, sans doute parce qu'il 
y avait déjà un 
[projet engagé](https://www.studiohoxha.com/salle-de-sport-residence-paris-16/)…

</details>


## Références

### Source des données

Les emplacements réservés pour logements sont désormais en open-data
sur le site de la Ville de Paris
[ici](https://opendata.paris.fr/explore/dataset/plub_res_logt/information/).


### Bibliographie

À plusieurs reprises, nous avons eu recours à des programmes en ligne de
commande pour automatiser des tâches.

Pour en savoir plus sur la ligne de commande et apprendre à maîtriser le
côté obsur de l'informatique, je recommande le livre [*La ligne de commande
par l'exemple*](https://www.h-k.fr/minimax.info.003LDCPE), de Céline
Chevalier, Sébastien Desreux, Vincent Fourmond (Paris, H&K, 2013). Un
ouvrage accessible, pédagogique et drôle.

![](/resources/plu-bio/ligne_commande_par_exemple.jpg){width=50%}
