---
title: "TD PLU Bioclimatique"
format: html
execute:
    eval: false
---

Dans ce TD, nous allons mettre en pratique quelques compétences acquises
dans les séances précédentes — et en acquérir de nouvelles — sur un cas
d'étude : le PLU Bioclimatique parisien.

Pour mémoire, la Ville de Paris a adopté en novembre 2024 son nouveau plan
local d'urbanisme. La mise en révision avait été engagée en décembre 2020.
Après une phase de concertation, le Conseil de Paris avait arrêté en juin
2023 un projet de PLU, qui a fait l'objet d'une enquête publique au tout
début de 2024.

À cette époque, le dossier d'enquête publique consistait en une multitude
de gros fichiers PDF : pas de géoportail, pas de couches SIG… Si l'on
voulait exploiter les données, il fallait se débrouiller.

Nous allons voir comment !


## Les planches graphiques au 1/2000e

Dans le PLU, l'une des pièces-clés est l'atlas des planches au 1/2000e.
Ces planches regroupent toutes les règles d'urbanisme applicables sur le
territoire parisien. Elles représentent une traduction graphique du
règlement écrit.

Cet atlas est aujourd'hui accessible en ligne sur le site 
[Règles d'urbanisme de Paris](https://regles-urbanisme.paris.fr/).



### Une planche

Notre objectif : afficher la planche D-05 dans QGIS. Pour cela, on va
la télécharger, la traiter et la géoréférencer.


#### Téléchargement

- Cliquer sur la carte interactive dans le rectangle D-05
- Dans la pop-up qui surgit, cliquer sur Vue pour télécharger la planche
  au format PDF.

[![](/resources/plu-bio/atlas_planches.jpeg)](https://regles-urbanisme.paris.fr/plu-bioclimatique/jsp/site/Portal.jsp?document_id=198&portlet_id=45#consultation_html)


#### Traitement

Nous avons un fichier PDF. Il nous faut le convertir au format image, 
puis éliminer le cartouche pour ne conserver que la carte. On peut par
exemple utiliser GIMP. Pour aller plus vite, l'image retraitée est
téléchargeable [ici](https://www.normalesup.org/~gmercier/D_05.jpg).

![](/resources/plu-bio/gimp_rognage.jpeg)


#### Géoréférencement

Géoréférencer une image, c'est associer à chacun des pixels qui la composent
une coordonnée géographique. Pour cela, il suffit de donner à QGIS les
coordonnées de quelques points de contrôle (aussi appelés points d'appuis). Il
se charge d'interpoler tous les autres.


##### Couche de référence

La qualité du géoréférencement dépend donc en grande partie du choix des
points de contrôle. Pour être le plus précis possible, on va charger dans
QGIS l'une des couches utilisée par l'APUR pour établir les cartes du PLU :
la couche de 
l'[emprise bâtie de Paris](https://opendata.apur.org/datasets/Apur::emprise-batie-paris/about).

Ce sera l'occasion d'apprendre comment utiliser des géoservices pour
afficher un flux sans téléchargement préalable, puisque l'APUR utilise 
ArcGIS Server.

- Créer un projet vide dans QGIS
- Sélectionner le SCR 2154 (RGF93v1 / Lambert-93)
- Couche > Ajouter une couche > Ajouter une couche de serveur ArcGIS REST
- URL du serveur : [https://carto2.apur.org/apur/rest/services/OPENDATA/](https://carto2.apur.org/apur/rest/services/OPENDATA/)

![](/resources/plu-bio/arcgis_rest.jpeg)

- Sélectionner la couche `EMPRISE_BATIE_PARIS`, `Période de construction`,
  celle au format raster, cela se chargera plus rapidement.

![](/resources/plu-bio/arcgis_emprises.jpeg)


##### Géocodage

Ouvrir l'outil de géoréférencement.

- Couche > Géoréférencer
- Fichier > Ouvrir un raster
- Choisir le fichier `D_05.jpg`

On définit ensuite les paramètres de la transformation, en conservant les
paramètres proposés par défaut (transformation linéaire, ré-échantillonnage
plus proche voisin) mais en cochant la case "créer seulement un fichier
World".

![](/resources/plu-bio/parametres_transformation.jpeg)

Puis, avec l'outil prévu à cet effet, sélectionner des points de contrôle,
en cliquant successivement sur un point de l'image puis le même point sur la
carte. On peut ici se contenter de trois points non alignés et distants les
uns des autres. À partir de 3 points, QGIS calcule les erreurs de
géoréférencement : en règle générale, il est bon d'avoir des écarts
inférieurs à 10 pixels.

Les points de contrôles utilisés dans l'image ci-dessous sont téléchargeables
[ici](/resources/plu-bio/D_05.jpg.points). On peut les charger si on le 
souhaite.

![](/resources/plu-bio/points-de-controles.jpeg)

Appliquer ensuite la transformation. La carte s'affiche à son emplacement à
Paris, on peut vérifier la qualité du géoréférencement en appliquant une
légère transparence.

![](/resources/plu-bio/carte_georeferencee.jpeg)


##### Fichier World

Par curiosité, et parce que cela nous sera utile plus tard, allons voir dans
le dossier contenant l'image `D_05.jpg`. On remarque qu'un nouveau fichier a
été créé : `D_05.wld`. Grâce à ce fichier, QGIS est capable de transformer
la coordonnée d'un pixel de l'image en coordonnée géographique. On peut
l'ouvrir avec un éditeur de texte. 

![](/resources/plu-bio/fichier_world.jpeg)

On retiendra :
- que les valeurs A et D sont des facteurs **d'échelle**, ie. donnent la
  taille d'un pixel dans les unités du SCR utilisé. Ici, 1 pixel sur l'image
  correspond donc à 0,169 m dans la réalité.
- que les valeurs B et C sont des termes de **rotation**. Ici, l'image n'a
  pas besoin d'être tournée, elle est bien au nord.
- que les valeurs E et F sont des termes de **translation**, ie. donnent la
  coordonnée géographique du point supérieur gauche de la carte. On peut le
  vérifier sur l'image ci-dessous.

![](/resources/plu-bio/point_reference.jpeg)

Pour les *gory details*, se référer à 
[cette page](https://pro.arcgis.com/en/pro-app/latest/help/data/imagery/world-files-for-raster-datasets.htm)



### Plein de planches

Nous avons traité une seule planche seule. Comment procéder si l'on devait
traiter l'ensemble des planches du PLU ? On se contentera d'esquisser les
solutions.


#### Téléchargement

On voit sur le site du PLU qu'une 
[liste des planches](https://regles-urbanisme.paris.fr/plu-bioclimatique/servlet/plugins/document/resource?id=751&id_attribute=93&working_content=true) 
est disponible, avec les liens vers chacune des 134 planches.

Le problème est que ces liens ne sont pas apparents… Pas de panique, il y a
d'autres solutions que de cliquer manuellement sur chaque ligne.

- Solution sans code : extraire la liste des liens avec un utilitaire en
  ligne comme 
  [Supertool](https://supertool.org/fr/extract-urls-and-links-from-pdfs/).
- Solution avec code : extraire la liste des liens avec un court script
  Python et la libraire [`PyMuPDF`](https://github.com/pymupdf/pymupdf).

```{python}
# Quelque chose comme cela
import pymupdf

doc = pymupdf.open('Consultation_des_planches_au_1_sur_2000.pdf')
for page in doc:
   for link in page.get_links():
       print(l['uri'])

```

Voici un 
[fichier texte](/resources/plu-bio/liste_urls.txt)) 
avec la liste des liens ainsi obtenue. Si on l'ouvre avec un
éditeur, on observe que les liens sont cassés. Le prestataire de la Ville de
Paris dont le nom figure dans les métadonnées du PDF a oublié de substituer
au nom du serveur de test celui utilisé en production. On le fait pour lui
grâce à la commande Find/Replace.

![](/resources/plu-bio/liste_urls_replace_all.jpeg)

Ceci fait, il est possible de télécharger tous les fichiers avec une boucle
en ligne de commande.

```{sh}
while read url; do wget --content-disposition $url;done < liste_urls.txt

```


#### Traitement

Toutes les planches PDF sont bâties sur le même modèle. Il serait donc aisé
d'automatiser la conversion en JPG et le rognage du cartouche. Photoshop
sait très bien le faire, GIMP également, mais avec un plugin. Le plus rapide
serait d'utiliser ImageMagick en ligne de commande.

```{sh}
# La commande pour les curieux
convert -density D_05.pdf D_05.jpg
convert D_05.jpg -crop 6492x4723+232+136 +repage crop/D_05.jpg

```


#### Géoréférencement

Pour géoréférencer les images obtenues, il faudrait simplement créer les
fichiers World. Pour cela, on peut remarquer que les planches sont espacées
très régulièrement : chaque planche est décalée de 750m en latitude et de
1000m en longitude. Il suffit de modifier les termes de translation
(paramètres E et F) en conséquence, en laissant le facteur d'échelle et 
les termes de rotation inchangés.

![](/resources/plu-bio/batch_fichier_world.jpeg)

Faisons le test sur un exemple : 

- Télécharger le fichier [`E_05.jpg`](https://www.normalesup.org/~gmercier/E_05.jpg).
- Copier le fichier `D_05.wld` en un fichier `E_05.wld`
- Ouvrir le fichier `E_05.wld` et ajouter 1000 au nombre de la 5e ligne
- QGIS > Couches > Ajouter une couche Raster > `E_05.jpg`

Miracle : la couche est parfaitement ajustée !

![](/resources/plu-bio/ajustement_parfait.jpeg)
